<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lobby</title>
  <style>
    body{font-family:system-ui;margin:0;padding:24px;background:#0b0b0f;color:#fff}
    .wrap{max-width:560px;margin:0 auto;display:flex;flex-direction:column;gap:14px}
    .card{background:#141420;border-radius:18px;padding:16px}
    .title{font-weight:900;margin-bottom:6px}
    .muted{opacity:.7;font-size:13px;line-height:1.4}
    .row{display:flex;gap:10px}
    .btn{
      width:100%;padding:14px;border-radius:14px;border:0;font-weight:900;
      background:#2a2a3a;color:#fff;cursor:pointer
    }
    .btnPrimary{background:#c714c7}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .pill{
      display:inline-block;
      background:#1f1f2c;
      border-radius:999px;
      padding:8px 12px;
      font-weight:900;
      margin-top:8px
    }
    .hidden{display:none}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="title">ë¡œë¹„</div>
    <div id="me" class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

    <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
      <div class="pill">â¤ï¸ ë°›ì€ í˜¸ê°: <span id="recv">0</span></div>
      <div class="pill">ë³´ë‚¸ ì‹œê·¸ë„: <span id="sent">0</span>/2</div>

      <!-- âœ… ë©”ì‹œì§€ ê¸°ëŠ¥ ì˜¤í”ˆ ì‹œì—ë§Œ ë…¸ì¶œ -->
      <div id="msgPill" class="pill hidden">
        ğŸ“© ë°›ì€ ë©”ì‹œì§€: <span id="msgCount">0</span>ê°œ
      </div>
    </div>
  </div>

  <div class="row">
    <button class="btn btnPrimary" onclick="location.href='/play/'">í˜¸ê° ë³´ë‚´ê¸°</button>
    <button class="btn" onclick="location.href='/match/'">ë§¤ì¹­ í™•ì¸</button>
  </div>

  <!-- 2ë¶€ ê¸°ëŠ¥ ë²„íŠ¼ -->
  <button id="featureBtn" class="btn" disabled>í™•ì¸ ì¤‘...</button>

  <button class="btn" onclick="logout()">ë‚˜ê°€ê¸°</button>
</div>

<form style="display:none;">{% csrf_token %}</form>

<script>
async function loadMe(){
  const res = await fetch("/api/me/");
  if(!res.ok){ location.href="/"; return; }
  const d = await res.json();

  document.getElementById("me").innerText = `${d.nickname} (${d.gender})`;
  document.getElementById("recv").innerText = d.received_count ?? 0;
  document.getElementById("sent").innerText = d.sent_count ?? 0;
}

async function loadMessageCount(){
  const res = await fetch("/api/message-count/");
  if(res.ok){
    const d = await res.json();
    document.getElementById("msgCount").innerText = d.count ?? 0;
  }
}

async function loadEventState(){
  const res = await fetch("/api/event-state/");
  if(!res.ok) return {message_open:false};
  return await res.json();
}

async function setupFeatureButton(){
  const state = await loadEventState();
  const btn = document.getElementById("featureBtn");
  const msgPill = document.getElementById("msgPill");

  if(!state.message_open){
    // 1ë¶€
    btn.innerText = "2ë¶€ì—ëŠ” ì¶”ê°€ê¸°ëŠ¥ì´ ì˜¤í”ˆë©ë‹ˆë‹¤";
    btn.disabled = true;
    msgPill.classList.add("hidden");
  } else {
    // 2ë¶€
    btn.innerText = "ë©”ì„¸ì§€ ë³´ë‚´ê¸°";
    btn.disabled = false;
    btn.onclick = () => location.href="/message/";
    msgPill.classList.remove("hidden");
    await loadMessageCount();
  }
}

async function logout(){
  await fetch("/api/logout/", {method:"POST", credentials:"same-origin"});
  location.href="/";
}

async function boot(){
  await loadMe();
  await setupFeatureButton();
  setInterval(loadMe, 3000);
}
boot();
</script>
</body>
</html>
