<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lobby</title>
  <style>
    :root{
      --bg:#0b0b0f;
      --line:rgba(255,255,255,.08);
      --muted:rgba(255,255,255,.74);
      --pink:#c714c7;
      --pink2:#ff6ad5;
      --white:#ffffff;
      --card1:rgba(255,255,255,.05);
      --card2:rgba(255,255,255,.02);
    }

    body{
      font-family:system-ui;
      margin:0;
      padding:24px;
      background:
        radial-gradient(1100px 520px at 50% -10%, rgba(199,20,199,.18), rgba(11,11,15,1) 62%),
        radial-gradient(900px 420px at 86% 8%, rgba(255,106,213,.10), rgba(11,11,15,0) 65%),
        radial-gradient(900px 420px at 12% 18%, rgba(199,20,199,.10), rgba(11,11,15,0) 60%),
        var(--bg);
      color:#fff;
        height:100vh;
    }

    .wrap{
      max-width:560px;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .card{
      background:linear-gradient(180deg, var(--card1), var(--card2));
      border:1px solid var(--line);
      border-radius:22px;
      padding:18px;
      box-shadow:
        0 22px 60px rgba(0,0,0,.58),
        0 0 44px rgba(199,20,199,.10);
      position:relative;
      overflow:hidden;
    }
    .card:before{
      content:"";
      position:absolute;
      inset:-40%;
      background: radial-gradient(closest-side, rgba(199,20,199,.16), rgba(199,20,199,0) 70%);
      transform: translate(40%, -30%);
      filter: blur(18px);
      pointer-events:none;
    }

    .brandRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }

    .title{
      font-weight:1000;
      font-size:18px;
      letter-spacing:-.2px;
      background: linear-gradient(120deg, var(--pink), var(--pink2), var(--white), var(--pink2), var(--pink));
      background-size: 420% 420%;
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      animation: gradMove 6s ease infinite;
      text-shadow:0 0 18px rgba(199,20,199,.32), 0 0 34px rgba(199,20,199,.16);
      margin:0;
    }
    @keyframes gradMove{
      0%{background-position:0% 50%;}
      50%{background-position:100% 50%;}
      100%{background-position:0% 50%;}
    }

    .chip{
      font-weight:1000;
      font-size:12px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(31,31,44,.8);
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      opacity:.95;
    }

    .nickname{
      font-weight:1000;
      font-size:28px;
      letter-spacing:-0.4px;
      line-height:1.15;
      text-align:center;
      margin:6px 0 2px 0;

      background: linear-gradient(135deg, #c714c7 0%, #ff6ad5 45%, #ffffff 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;

      text-shadow:
        0 0 12px rgba(199, 20, 199, 0.35),
        0 0 26px rgba(199, 20, 199, 0.14);
    }

    .muted{
      color:var(--muted);
      font-size:13px;
      line-height:1.45;
      text-align:center;
      opacity:.95;
    }

    .pillWrap{
      margin-top:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      align-items:center;
      text-align:center;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:rgba(31,31,44,.88);
      border:1px solid rgba(255,255,255,.06);
      border-radius:999px;
      padding:10px 14px;
      font-weight:1000;
      box-shadow:0 10px 24px rgba(0,0,0,.25);
    }
    .pill strong{ font-weight:1000; color:#fff; }
    .hidden{ display:none; }

    .row{ display:flex; gap:10px; }

    .btn{
      width:100%;
      padding:14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      font-weight:1000;
      cursor:pointer;
      background:#2a2a3a;
      color:#fff;
      transition: transform .14s ease, filter .18s ease, box-shadow .2s ease, opacity .2s ease;
    }
    .btn:active{ transform:scale(.99); }
    .btn:hover{ filter:brightness(1.06); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; box-shadow:none; }

    .btnPrimary{
      background: var(--pink);
      border-color: rgba(199,20,199,.35);
      box-shadow: 0 14px 34px rgba(199,20,199,.24);
    }
    .btnPrimary:hover{ box-shadow: 0 16px 38px rgba(199,20,199,.30); }

    .btnDanger{
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.10);
    }

    .dividerNote{
      margin-top:8px;
      padding:12px 14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(16,16,26,.7);
      text-align:center;
      box-shadow: inset 0 0 0 1px rgba(199,20,199,.06);
    }

    .tiny{
      font-size:12px;
      color:rgba(255,255,255,.62);
      line-height:1.4;
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <div class="brandRow">
      <h1 class="title">ONE LIGHT</h1>

    </div>
    <div class="muted">ì˜¤ëŠ˜ì˜ ì—°ê²°, ì§€ê¸ˆ ì‹œì‘í•´ìš”.</div>
    <div id="me" class="nickname">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>


    <div class="pillWrap">
      <div class="pill">â¤ï¸ ë°›ì€ ì‹œê·¸ë„ <strong><span id="recv">0</span></strong></div>
      <div class="pill">ğŸ’™ ë³´ë‚¸ ì‹œê·¸ë„ <strong><span id="sent">0</span>/2</strong></div>

      <div id="msgPill" class="pill hidden">ğŸ“© ë°›ì€ ë©”ì‹œì§€ <strong><span id="msgCount">0</span>ê°œ</strong></div>
    </div>
  </div>

  <div class="row">
    <button class="btn btnPrimary" onclick="location.href='/play/'">í˜¸ê° ë³´ë‚´ê¸°</button>
    <button class="btn" onclick="location.href='/match/'">ë§¤ì¹­ í™•ì¸</button>
  </div>

  <!-- 2ë¶€ ê¸°ëŠ¥ ë²„íŠ¼ -->
  <button id="featureBtn" class="btn" disabled>í™•ì¸ ì¤‘...</button>

  <button class="btn btnDanger" onclick="logout()">ë‚˜ê°€ê¸°</button>

  <div class="dividerNote">
    <div class="tiny">* ì§„í–‰ ì¤‘ ë¬¸ì œê°€ ìˆìœ¼ë©´ í˜¸ìŠ¤íŠ¸ì—ê²Œ ë°”ë¡œ ë§ì”€í•´ì£¼ì„¸ìš”.</div>
  </div>
</div>

<form style="display:none;">{% csrf_token %}</form>

<script>
/* ===== ê³µí†µ: timeout fetch ===== */
async function fetchWithTimeout(url, opts={}, ms=4000){
  const ctrl = new AbortController();
  const t = setTimeout(()=> ctrl.abort(), ms);
  try{ return await fetch(url, { ...opts, signal: ctrl.signal }); }
  finally{ clearTimeout(t); }
}

/* âœ… ë©”ì‹œì§€ í˜ì´ì§€ì™€ ë™ì¼í•œ ì ê¸ˆ í‚¤ */
const CLIENT_LOCK_KEY = "onelight_message_locked";

function isMessageLockedPersisted(){
  return localStorage.getItem(CLIENT_LOCK_KEY) === "1";
}

async function loadMe(){
  const res = await fetchWithTimeout("/api/me/");
  if(!res.ok){ location.href="/"; return; }
  const d = await res.json();

  document.getElementById("me").innerText = `${d.nickname}`;
  document.getElementById("recv").innerText = d.received_count ?? 0;
  document.getElementById("sent").innerText = d.sent_count ?? 0;
}

async function loadMessageCount(){
  const res = await fetchWithTimeout("/api/message-count/");
  if(res.ok){
    const d = await res.json();
    document.getElementById("msgCount").innerText = d.count ?? 0;
  }
}

async function loadEventState(){
  const res = await fetchWithTimeout("/api/event-state/");
  if(!res.ok) return {message_open:false};
  return await res.json();
}

function setFeatureClosed(btn, msgPill){
  btn.innerText = "2ë¶€ì—ëŠ” ì¶”ê°€ê¸°ëŠ¥ì´ ì˜¤í”ˆë©ë‹ˆë‹¤";
  btn.disabled = true;
  btn.onclick = null;
  msgPill.classList.add("hidden");
}

async function setFeatureExpired(btn, msgPill){
  btn.innerText = "ë©”ì„¸ì§€ ë³´ë‚´ê¸° ì‹œê°„ì´ ì¢…ë£Œë˜ì—ˆì–´ìš”";
  btn.disabled = true;
  btn.onclick = null;

  msgPill.classList.remove("hidden");
  await loadMessageCount();
}

async function setFeatureOpen(btn, msgPill){
  btn.innerText = "ë©”ì„¸ì§€ ë³´ë‚´ê¸°";
  btn.disabled = false;
  btn.onclick = () => location.href="/message/";
  msgPill.classList.remove("hidden");
  await loadMessageCount();
}

async function setupFeatureButton(){
  const btn = document.getElementById("featureBtn");
  const msgPill = document.getElementById("msgPill");

  // âœ… ì ê¸ˆì´ 1ìˆœìœ„: ì„œë²„ê°€ openì´ë“  ë­ë“  "ì‹œê°„ ì¢…ë£Œ"ë¡œ ê³ ì •
  if(isMessageLockedPersisted()){
    setFeatureExpired(btn, msgPill);
    return;
  }

  const state = await loadEventState();

  if(!state.message_open){
    setFeatureClosed(btn, msgPill);
    return;
  }

  // ì„œë²„ê°€ message_lockedë¥¼ ì£¼ê¸° ì‹œì‘í•˜ë©´ ì¦‰ì‹œ ë°˜ì˜
  if(state.message_locked === true){
    localStorage.setItem(CLIENT_LOCK_KEY, "1");
    setFeatureExpired(btn, msgPill);
    return;
  }

  await setFeatureOpen(btn, msgPill);
}

async function logout(){
  await fetchWithTimeout("/api/logout/", {method:"POST", credentials:"same-origin"}, 5000);
  location.href="/";
}

async function boot(){
  await loadMe();
  await setupFeatureButton();
  setInterval(loadMe, 3000);

  // âœ… ë¡œë¹„ì—ì„œë„ ìƒíƒœê°€ ë°”ë€” ìˆ˜ ìˆìœ¼ë‹ˆ(2ë¶€ ì˜¤í”ˆ/ì¢…ë£Œ) ë²„íŠ¼ ìƒíƒœë„ ì£¼ê¸°ì ìœ¼ë¡œ ê°±ì‹ 
  setInterval(setupFeatureButton, 4000);
}

boot().catch((e)=>{
  console.error(e);
  const btn = document.getElementById("featureBtn");
  btn.innerText = "ìƒˆë¡œê³ ì¹¨";
  btn.disabled = false;
  btn.onclick = ()=> location.reload();
});
</script>
</body>
</html>
