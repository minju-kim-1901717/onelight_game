<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Play</title>
  <style>
    body{font-family:system-ui;margin:0;padding:24px;background:#0b0b0f;color:#fff}
    .wrap{max-width:560px;margin:0 auto}

    .top{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:14px}
    .pill{
      background:#1f1f2c;border-radius:999px;padding:8px 12px;font-weight:900;
      border:1px solid rgba(255,255,255,.06);
      box-shadow: 0 0 0 rgba(199,20,199,0);
      transition: transform .15s ease, box-shadow .2s ease, border-color .2s ease;
    }

    .sectionTitle{margin:14px 0 10px 0;font-weight:900;opacity:.9}

    .list{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}

    .item{
      background:#141420;
      border-radius:14px;
      padding:14px 12px;
      cursor:pointer;
      display:flex;
      justify-content:center;
      align-items:center;
      font-weight:900;
      position:relative;

      border:1px solid rgba(255,255,255,.06);
      transform: translateZ(0);
      transition: transform .16s ease, box-shadow .22s ease, border-color .22s ease, filter .22s ease;
      user-select:none;
    }

    /* âœ… ì¹´ë“œ ê°„ì§€: hover í™•ëŒ€ + í•‘í¬ ê¸€ë¡œìš° */
    .item:hover{
      transform: scale(1.025);
      border-color: rgba(199,20,199,.35);
      box-shadow:
        0 0 0 1px rgba(199,20,199,.12),
        0 10px 28px rgba(0,0,0,.35),
        0 0 22px rgba(199,20,199,.18);
      filter: brightness(1.06);
    }
    .item:active{
      transform: scale(0.99);
      filter: brightness(1.02);
    }

    .item.sent{
      opacity:.35;
      cursor:not-allowed;
      box-shadow:none !important;
      transform:none !important;
      border-color: rgba(255,255,255,.06) !important;
      filter:none !important;
    }

    /* âœ… "ë³´ëƒ„" íƒœê·¸ í•‘í¬ í¬ì¸íŠ¸ */
    .tag{
      position:absolute;
      right:10px;
      top:10px;
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      background: rgba(199,20,199,.16);
      border:1px solid rgba(199,20,199,.35);
      color: #ffd6ff;
      box-shadow: 0 0 14px rgba(199,20,199,.14);
      letter-spacing: .2px;
    }

    .muted{opacity:.7;margin-top:10px;font-size:13px;line-height:1.4}

    /* âœ… ëª¨ë‹¬: í˜ì´ë“œ + ìŠ¬ë¼ì´ë“œ */
    .backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.6);
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;

      opacity:0;
      transition: opacity .18s ease;
    }
    .backdrop.show{
      display:flex;
      opacity:1;
    }

    .modal{
      width:100%;
      max-width:420px;
      background:#141420;
      border-radius:18px;
      padding:18px;

      border:1px solid rgba(255,255,255,.06);
      box-shadow:
        0 14px 40px rgba(0,0,0,.55),
        0 0 26px rgba(199,20,199,.14);

      transform: translateY(10px) scale(.985);
      opacity:0;
      transition: transform .22s ease, opacity .22s ease;
    }
    .backdrop.show .modal{
      transform: translateY(0) scale(1);
      opacity:1;
    }

    .modal h3{margin:0 0 8px 0}
    .modal .row{display:flex;gap:10px;margin-top:14px}

    .btn{
      flex:1;
      padding:14px;
      border-radius:14px;
      border:0;
      font-weight:900;
      cursor:pointer;
      transition: transform .14s ease, filter .18s ease, box-shadow .2s ease;
    }
    .btn:active{ transform: scale(.99); }

    .btn-cancel{
      background:#2a2a3a;
      color:#fff;
      border:1px solid rgba(255,255,255,.08);
    }
    .btn-cancel:hover{ filter: brightness(1.05); }

    .btn-ok{
      background:#c714c7;
      color:#fff;
      box-shadow: 0 10px 26px rgba(199,20,199,.22);
    }
    .btn-ok:hover{
      filter: brightness(1.06);
      box-shadow: 0 12px 30px rgba(199,20,199,.28);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="pill">ğŸ’™ ë³´ë‚¸ ì‹œê·¸ë„: <span id="sent">0</span>/2</div>
      <div class="pill">â¤ï¸ ë°›ì€ ì‹œê·¸ë„: <span id="recv">0</span></div>
      <div class="pill" id="meinfo">...</div>
    </div>
    <div class="muted">
        â€¢ ë‹‰ë„¤ì„ì„ ëˆ„ë¥´ë©´ ì‹œê·¸ë„ì´ ì „ì†¡ë¼ìš” <br>
        â€¢ ì‹œê·¸ë„ì€ ë‘ê°œê¹Œì§€ë§Œ ë³´ë‚¼ ìˆ˜ ìˆì–´ìš”<br>
        â€¢ ì„œë¡œ ë§¤ì¹­ë˜ë©´ ë§¤ì¹­í™•ì¸ ì¹¸ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”
    </div>

    <div class="sectionTitle" id="sectionTitle">ìƒëŒ€ ë‹‰ë„¤ì„</div>
    <div id="list" class="list"></div>
  </div>

  <div id="backdrop" class="backdrop">
    <div class="modal">
      <h3>ì‹œê·¸ë„ ë³´ë‚´ê¸°</h3>
      <div id="targetText" class="muted"></div>
      <div class="row">
        <button class="btn btn-cancel" id="btnCancel">ì·¨ì†Œ</button>
        <button class="btn btn-ok" id="btnOk">í™•ì¸</button>
      </div>
    </div>
  </div>

  <form style="display:none;">{% csrf_token %}</form>

<script>
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}

let selected = null;
let me = null;

function openModal(card){
  if(card.sent){ alert("ì´ë¯¸ ë³´ëƒ„!"); return; }
  selected = card;
  document.getElementById("targetText").innerText = `"${card.nickname}" ë‹˜ì—ê²Œ ì‹œê·¸ë„ì„ ë³´ë‚¼ê¹Œìš”?`;
  const bd = document.getElementById("backdrop");
  bd.classList.add("show");
}
function closeModal(){
  selected = null;
  const bd = document.getElementById("backdrop");
  bd.classList.remove("show");
  // transition ëë‚˜ê¸° ì „ì— display none ë˜ë©´ ì• ë‹ˆë©”ì´ì…˜ ê¹¨ì ¸ì„œ,
  // show í´ë˜ìŠ¤ë¡œë§Œ ì»¨íŠ¸ë¡¤ (CSSì—ì„œ show ì—†ìœ¼ë©´ opacity 0 + display none ìƒíƒœ)
}

async function refreshMe(){
  const res = await fetch("/api/me/");
  if(!res.ok){ location.href="/"; return null; }
  me = await res.json();
  document.getElementById("sent").innerText = me.sent_count;
  document.getElementById("recv").innerText = me.received_count;

  // âœ… ë‹‰ë„¤ì„ë§Œ
  document.getElementById("meinfo").innerText = `${me.nickname}`;

  if(me.sent_count >= 2){
    alert("ì‹œê·¸ë„ 2ê°œë¥¼ ëª¨ë‘ ì‚¬ìš©í–ˆì–´ìš”!");
    location.href="/lobby/";
  }
  return me;
}

async function loadList(){
  const res = await fetch("/api/cards/");
  const data = await res.json();
  const cards = data.cards || [];
  const list = document.getElementById("list");
  list.innerHTML = "";

  const oppLabel = (me.gender === "M") ? "ì—¬ì ë‹‰ë„¤ì„" : "ë‚¨ì ë‹‰ë„¤ì„";
  document.getElementById("sectionTitle").innerText = oppLabel;

  if(cards.length === 0){
    list.innerHTML = `<div class="muted">ì§€ê¸ˆì€ ë³´ì—¬ì¤„ ë‹‰ë„¤ì„ì´ ì—†ì–´ìš”.</div>`;
    return;
  }

  for(const c of cards){
    const div = document.createElement("div");
    div.className = "item" + (c.sent ? " sent" : "");
    div.innerText = c.nickname;

    if(c.sent){
      const tag = document.createElement("div");
      tag.className = "tag";
      tag.innerText = "ë³´ëƒ„";
      div.appendChild(tag);
    }

    div.onclick = () => openModal(c);
    list.appendChild(div);
  }
}

async function sendSignal(toId){
  const csrftoken = getCookie("csrftoken");
  const res = await fetch("/api/signal/", {
    method: "POST",
    credentials: "same-origin",
    headers: {"Content-Type":"application/json","X-CSRFToken": csrftoken},
    body: JSON.stringify({to_id: toId})
  });
  const data = await res.json().catch(()=> ({}));
  if(!res.ok){ alert(data.error || "ì „ì†¡ ì‹¤íŒ¨"); return false; }
  return true;
}

async function boot(){
  await refreshMe();

  // ì‹¤ì‹œê°„(ë°›ì€ ì‹œê·¸ë„, ë§¤ì¹­)
  const wsProto = location.protocol === "https:" ? "wss" : "ws";
  const ws = new WebSocket(`${wsProto}://${location.host}/ws/participant/${me.id}/`);
  ws.onmessage = (e) => {
    const data = JSON.parse(e.data);
    if(data.type === "received_update"){
      document.getElementById("recv").innerText = data.received_count;
    }
    if(data.type === "match_created"){
      alert(`ğŸ‰ ${data.partner_nickname} ë‹˜ê³¼ ë§¤ì¹­! /match ì—ì„œ í™•ì¸ ê°€ëŠ¥`);
    }
  };

  await loadList();

  document.getElementById("btnCancel").onclick = closeModal;
  document.getElementById("backdrop").onclick = (e) => {
    if(e.target.id === "backdrop") closeModal();
  };
  document.getElementById("btnOk").onclick = async () => {
    if(!selected) return;
    const ok = await sendSignal(selected.id);
    closeModal();
    if(ok){
      await refreshMe();
      await loadList();
    }
  };
}
boot();
</script>
</body>
</html>
