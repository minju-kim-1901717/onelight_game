<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Join</title>
  <style>
    body{font-family:system-ui;margin:0;padding:24px;background:#0b0b0f;color:#fff}
    .card{max-width:460px;margin:0 auto;background:#141420;border-radius:16px;padding:18px}
    input,select,button{
      width:96%;padding:14px;border-radius:50px;border:0;margin-top:10px;
      font-size:16px; text-align:center;
    }
    input,select{background:#1f1f2c;color:#fff;appearance:none}
    select{cursor:pointer}
    button{background:#c714c7;color:#fff;font-weight:800;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed; margin: auto; display: block}
    .hint{opacity:.7;font-size:12px;margin-top:10px;line-height:1.5}
    .row{display:flex;gap:10px}
    .row > *{flex:1}
  </style>
</head>
<body>
  <div class="card">
    <h2 style="margin:0 0 6px 0; text-align: center">OneLight 입장</h2>

    <input id="code" placeholder="이벤트 코드" autocomplete="off" />
    <input id="nickname" placeholder="닉네임" maxlength="30" autocomplete="off" />

    <div class="row">
      <select id="gender">
        <option value="">성별</option>
        <option value="M">남</option>
        <option value="F">여</option>
      </select>
      <input id="pin" placeholder="개인 비밀번호 (4~12자리)" autocomplete="off" />
    </div>

    <button id="btn">입장</button>

    <div class="hint">
      • 화면애 있는 이벤트 코드를 입력해주새요<br/>
      • 신청한 닉넥임과 같은 닉네임으로 설정해주새요
    </div>
  </div>

  <!-- CSRF 토큰을 템플릿에서 한 번 사용해서 쿠키가 안정적으로 세팅되게 함 -->
  <form style="display:none;">{% csrf_token %}</form>

<script>
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}

document.getElementById("btn").onclick = async () => {
  const code = document.getElementById("code").value.trim();
  const nickname = document.getElementById("nickname").value.trim();
  const gender = document.getElementById("gender").value;
  const pin = document.getElementById("pin").value.trim();

  if(!code || !nickname || !gender || pin.length < 4 || pin.length > 12){
    alert("코드/닉네임/성별/비밀번호(4~12자리) 입력!");
    return;
  }

  const csrftoken = getCookie("csrftoken");

  const res = await fetch("/api/join/", {
    method: "POST",
    credentials: "same-origin",
    headers: {
      "Content-Type":"application/json",
      "X-CSRFToken": csrftoken,
    },
    body: JSON.stringify({code, nickname, gender, pin})
  });

  const data = await res.json().catch(()=> ({}));
  if(!res.ok){
    alert(data.error || "입장 실패");
    return;
  }
  location.href = "/lobby/";
};
</script>
</body>
</html>
