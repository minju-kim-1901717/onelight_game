<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë©”ì‹œì§€</title>
  <style>
    :root{
      --bg:#0b0b0f;
      --card:#141420;
      --card2:#10101a;
      --line:rgba(255,255,255,.08);
      --muted:rgba(255,255,255,.72);
      --pink:#c714c7;
      --pink2:#ff6ad5;
      --white:#ffffff;
    }

    body{
      font-family:system-ui;
      margin:0;
      padding:24px;
      background:
        radial-gradient(900px 420px at 50% -10%, rgba(199,20,199,.20), rgba(11,11,15,1) 60%),
        radial-gradient(800px 360px at 85% 10%, rgba(255,106,213,.10), rgba(11,11,15,0) 60%),
        var(--bg);
      color:#fff;
    }

    .wrap{
      max-width:560px;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:20px;
      padding:18px;
      box-shadow:
        0 22px 60px rgba(0,0,0,.58),
        0 0 44px rgba(199,20,199,.10);
      position:relative;
      overflow:hidden;
    }

    /* subtle light sweep */
    .card:before{
      content:"";
      position:absolute;
      inset:-40%;
      background: radial-gradient(closest-side, rgba(199,20,199,.16), rgba(199,20,199,0) 70%);
      transform: translate(40%, -30%);
      filter: blur(18px);
      pointer-events:none;
    }

    .title{
      font-weight:1000;
      margin:0 0 6px 0;
      font-size:20px;
      letter-spacing:-.2px;

      background: linear-gradient(120deg, var(--pink), var(--pink2), var(--white), var(--pink2), var(--pink));
      background-size: 400% 400%;
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      animation: gradientMove 5.5s ease infinite;

      text-shadow:
        0 0 18px rgba(199,20,199,.35),
        0 0 34px rgba(199,20,199,.18);
    }

    @keyframes gradientMove{
      0%{ background-position:0% 50%; }
      50%{ background-position:100% 50%; }
      100%{ background-position:0% 50%; }
    }

    .muted{
      opacity:.78;
      font-size:13px;
      line-height:1.45;
      color:var(--muted);
    }

    .pillWrap{
      margin-top:12px;
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      text-align:center;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:rgba(31,31,44,.9);
      border:1px solid rgba(255,255,255,.06);
      border-radius:999px;
      padding:10px 14px;
      font-weight:1000;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
    }

    .pill strong{
      font-weight:1000;
      color:#fff;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      margin-top:12px;
      padding:8px 12px;
      border-radius:999px;
      font-weight:1000;
      font-size:12px;
      letter-spacing:.2px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(199,20,199,.14);
      box-shadow: 0 0 22px rgba(199,20,199,.16);
    }

    .btn{
      width:100%;
      padding:14px;
      border-radius:14px;
      border:0;
      font-weight:1000;
      cursor:pointer;
      transition: transform .14s ease, filter .18s ease, box-shadow .2s ease, opacity .2s ease;
    }
    .btn:active{ transform:scale(.99); }

    .btnPrimary{
      background: var(--pink);
      color:#fff;
      box-shadow: 0 14px 34px rgba(199,20,199,.24);
    }
    .btnPrimary:hover{ filter:brightness(1.06); box-shadow: 0 16px 38px rgba(199,20,199,.30); }

    .btnGhost{
      background:#2a2a3a;
      color:#fff;
      border:1px solid rgba(255,255,255,.08);
    }
    .btnGhost:hover{ filter:brightness(1.06); }

    .btn:disabled{opacity:.55;cursor:not-allowed;box-shadow:none}

    /* composer */
    .composer{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    }

    .composerHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }

    .lockHint{
      margin-top:10px;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(16,16,26,.75);
      box-shadow: inset 0 0 0 1px rgba(199,20,199,.06);
    }

    select, textarea{
      width:100%;
      margin-top:12px;
      background: rgba(11,11,15,.95);
      color:#fff;
      border:1px solid rgba(255,255,255,.14);
      border-radius:16px;
      padding:12px 12px;
      font-size:15px;
      outline:none;
      transition: border-color .2s ease, box-shadow .2s ease, filter .2s ease;
    }
    select:focus, textarea:focus{
      border-color: rgba(199,20,199,.55);
      box-shadow:
        0 0 0 4px rgba(199,20,199,.14),
        0 0 22px rgba(199,20,199,.12);
      filter: brightness(1.03);
    }
    textarea{min-height:110px; resize:none;}

    .counterRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-top:10px;
      color:var(--muted);
      font-size:13px;
    }

    .miniPill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border-radius:999px;
      background: rgba(31,31,44,.9);
      border:1px solid rgba(255,255,255,.06);
      font-weight:1000;
    }

    .hidden{display:none}

    /* fullscreen FX */
    .fx{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:24px;
      background: rgba(0,0,0,.72);
      backdrop-filter: blur(6px);
      z-index:9999;
      overflow:hidden;
      opacity:0;
      transition: opacity .18s ease;
    }
    .fx.show{ display:flex; opacity:1; }

    .fxPanel{
      width:min(540px, 92vw);
      border-radius:22px;
      padding:20px 18px;
      text-align:center;
      border:1px solid rgba(255,255,255,.10);
      background: radial-gradient(900px 320px at 50% 0%, rgba(199,20,199,.22), rgba(20,20,32,.92) 60%);
      box-shadow:
        0 30px 90px rgba(0,0,0,.7),
        0 0 70px rgba(199,20,199,.22);
      transform: translateY(14px) scale(.96);
      opacity:0;
      animation: fxIn .28s ease forwards;
      position:relative;
      overflow:hidden;
    }
    @keyframes fxIn{
      to{ transform: translateY(0) scale(1); opacity:1; }
    }

    .fxTitle{
      font-weight:1000;
      font-size:26px;
      letter-spacing:-0.3px;
      margin:0;

      background: linear-gradient(120deg, var(--pink), var(--pink2), var(--white), var(--pink2), var(--pink));
      background-size: 420% 420%;
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      animation: gradientMove 4.5s ease infinite;

      text-shadow:
        0 0 22px rgba(199,20,199,.50),
        0 0 40px rgba(199,20,199,.25);
    }
    .fxSub{ margin-top:8px; opacity:.82; font-weight:900; }
    .fxName{
      margin-top:14px;
      font-weight:1000;
      font-size:18px;
      color:#fff;
      opacity:.95;
    }
    .fxBtn{
      margin-top:16px;
      width:100%;
      padding:14px;
      border-radius:14px;
      border:0;
      font-weight:1000;
      background:var(--pink);
      color:#fff;
      cursor:pointer;
      box-shadow: 0 12px 30px rgba(199,20,199,.25);
    }

    .confetti{
      position:absolute;
      top:-10px;
      width:10px;
      height:14px;
      opacity:.9;
      border-radius:3px;
      animation: fall 1.6s linear forwards;
      filter: drop-shadow(0 0 10px rgba(199,20,199,.18));
    }
    @keyframes fall{
      to{ transform: translateY(110vh) rotate(540deg); opacity:0.2; }
    }
  </style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <div class="title">2ë¶€ MESSAGE âœ¨</div>
    <div id="desc" class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

    <div class="pillWrap">
      <div class="pill">ğŸ“© ë°›ì€ ë©”ì‹œì§€ <strong><span id="msgCount">0</span>ê°œ</strong></div>
      <div id="limitPill" class="pill hidden">âœ‰ï¸ ë‚´ ì „ì†¡ <strong><span id="sentMsg">0</span>/1</strong></div>
      <div id="timerPill" class="pill hidden">â±ï¸ ë‚¨ì€ ì‹œê°„ <strong><span id="remain">--:--</span></strong></div>
    </div>

    <div id="badge" class="badge hidden">ğŸ’ 2ë¶€ ì „ìš© ê¸°ëŠ¥ Â· 10ë¶„ ë™ì•ˆ 1íšŒë§Œ ì „ì†¡ ê°€ëŠ¥</div>

    <button id="actionBtn" class="btn btnPrimary" disabled>í™•ì¸ ì¤‘...</button>
  </div>

  <!-- ë©”ì‹œì§€ ì‘ì„± ì˜ì—­ (ì˜¤í”ˆ í›„ì—ë§Œ í‘œì‹œ) -->
  <div id="composerCard" class="card composer hidden">
    <div class="composerHeader">
      <div>
        <div class="title" style="font-size:18px;margin:0;">ë©”ì‹œì§€ ë³´ë‚´ê¸°</div>
        <div class="muted" style="margin-top:6px;">
          ë‹‰ë„¤ì„ ì„ íƒ í›„ <b>200ì ì´ë‚´</b>ë¡œ ì‘ì„±í•˜ì„¸ìš”.<br/>
          <span style="opacity:.9;">(ë©”ì‹œì§€ ë‚´ìš©ì€ í˜„ì¬ ê´€ë¦¬ìë§Œ í™•ì¸)</span>
        </div>
      </div>
      <div class="miniPill">1íšŒ ì œí•œ</div>
    </div>

    <div class="lockHint">
      <div class="muted">
        âœ… <b>2ë¶€ë§Œì˜ íŠ¹ìˆ˜ ê¸°ëŠ¥</b>ì´ì—ìš”.<br/>
        ì‹œê°„ ëë‚˜ë©´ ìë™ ì ê¸ˆë¼ìš”.
      </div>
    </div>

    <select id="toSelect">
      <option value="">ë°›ëŠ” ì‚¬ëŒ ì„ íƒ</option>
    </select>

    <textarea id="text" maxlength="200" placeholder="ì§€ê¸ˆ ì´ ìˆœê°„ë§Œì˜ í•œë§ˆë””ë¥¼ ë‚¨ê²¨ì¤˜ (200ì ì´ë‚´)"></textarea>

    <div class="counterRow">
      <div class="muted">ì •ì„±ì€ ì§§ì•„ë„ í‹° ë‚˜ìš”.</div>
      <div class="miniPill"><span id="count">0</span>/200</div>
    </div>

    <button id="sendBtn" class="btn btnPrimary">ì „ì†¡</button>
  </div>

  <div class="row" style="display:flex;gap:10px">
    <button class="btn btnGhost" onclick="location.href='/match/'">ë§¤ì¹­ í™•ì¸</button>
    <button class="btn btnGhost" onclick="location.href='/lobby/'">ë¡œë¹„</button>
  </div>

</div>

<form style="display:none;">{% csrf_token %}</form>

<!-- Fullscreen FX -->
<div id="fx" class="fx" onclick="closeFxIfBackdrop(event)">
  <div class="fxPanel">
    <h1 class="fxTitle" id="fxTitle">2ë¶€ ê¸°ëŠ¥</h1>
    <div class="fxSub" id="fxSub">ì˜¤í”ˆ</div>
    <div class="fxName" id="fxName"></div>
    <button class="fxBtn" onclick="closeFx()">í™•ì¸</button>
  </div>
</div>

<script>
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(\`; \${name}=\`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}

let me = null;
let messageOpen = false;
let messageLocked = false;
let messageSent = false;

// ìƒíƒœ ìºì‹œ
let stateCache = null;
// íƒ€ì´ë¨¸
let timerInterval = null;

function closeFxIfBackdrop(e){
  if(e.target.id === "fx") closeFx();
}
function closeFx(){
  document.getElementById("fx").classList.remove("show");
}

function burstConfetti(){
  const fx = document.getElementById("fx");
  const colors = ["#c714c7","#ff6ad5","#ffffff","#8a2be2","#ff4fd8"];
  for(let i=0;i<46;i++){
    const el = document.createElement("div");
    el.className = "confetti";
    el.style.left = Math.random()*100 + "vw";
    el.style.background = colors[Math.floor(Math.random()*colors.length)];
    el.style.transform = \`translateY(0) rotate(\${Math.random()*180}deg)\`;
    el.style.animationDuration = (1.2 + Math.random()*0.9) + "s";
    el.style.width = (6 + Math.random()*10) + "px";
    el.style.height = (8 + Math.random()*16) + "px";
    el.style.opacity = (0.55 + Math.random()*0.45);
    fx.appendChild(el);
    setTimeout(()=> el.remove(), 2200);
  }
}

function showFx({title, sub, name}){
  document.getElementById("fxTitle").innerText = title || "2ë¶€ ê¸°ëŠ¥";
  document.getElementById("fxSub").innerText = sub || "";
  document.getElementById("fxName").innerText = name || "";
  const fx = document.getElementById("fx");
  fx.classList.add("show");
  burstConfetti();
}

function fmtRemain(sec){
  sec = Math.max(0, Math.floor(sec));
  const m = String(Math.floor(sec/60)).padStart(2,"0");
  const s = String(sec%60).padStart(2,"0");
  return `${m}:${s}`;
}

function setUIForClosed(){
  document.getElementById("desc").innerText = "ë©”ì‹œì§€ ê¸°ëŠ¥ì€ 2ë¶€ì—ì„œ ì˜¤í”ˆë©ë‹ˆë‹¤.";
  const btn = document.getElementById("actionBtn");
  btn.innerText = "2ë¶€ì—ëŠ” ì¶”ê°€ê¸°ëŠ¥ì´ ì˜¤í”ˆë©ë‹ˆë‹¤";
  btn.disabled = true;
  document.getElementById("composerCard").classList.add("hidden");
  document.getElementById("badge").classList.add("hidden");
  document.getElementById("timerPill").classList.add("hidden");
  document.getElementById("limitPill").classList.add("hidden");
}

function setUIForOpen(){
  // ìƒë‹¨ ì•ˆë‚´
  document.getElementById("desc").innerHTML = "ğŸ’ <b>2ë¶€ ë©”ì‹œì§€ ê¸°ëŠ¥</b>ì´ ì˜¤í”ˆë˜ì—ˆìŠµë‹ˆë‹¤. <br/>10ë¶„ ë™ì•ˆ <b>1íšŒ</b>ë§Œ ë³´ë‚¼ ìˆ˜ ìˆì–´ìš”.";
  document.getElementById("badge").classList.remove("hidden");

  // pill ë…¸ì¶œ
  document.getElementById("timerPill").classList.remove("hidden");
  document.getElementById("limitPill").classList.remove("hidden");

  const btn = document.getElementById("actionBtn");

  // ì ê¸ˆ/ì „ì†¡ ìƒíƒœ ì²˜ë¦¬
  if(messageLocked){
    btn.innerText = "ì ê¸ˆë¨ (ì‹œê°„ ì¢…ë£Œ)";
    btn.disabled = true;
    document.getElementById("composerCard").classList.add("hidden");
    return;
  }

  if(messageSent){
    btn.innerText = "ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ";
    btn.disabled = true;
    document.getElementById("composerCard").classList.add("hidden");
    return;
  }

  btn.innerText = "ë©”ì„¸ì§€ ë³´ë‚´ê¸°";
  btn.disabled = false;
  btn.onclick = () => {
    document.getElementById("composerCard").classList.remove("hidden");
    document.getElementById("composerCard").scrollIntoView({behavior:"smooth"});
  };
}

async function loadMe(){
  const res = await fetch("/api/me/");
  if(!res.ok){ location.href="/"; return; }
  me = await res.json();
}

/* ë°›ì€ ë©”ì‹œì§€ ê°œìˆ˜ */
async function loadMessageCount(){
  const res = await fetch("/api/message-count/");
  if(res.ok){
    const d = await res.json();
    document.getElementById("msgCount").innerText = d.count ?? 0;
  }
}

/* ì´ë²¤íŠ¸ ìƒíƒœ: message_open + (ê°€ëŠ¥í•˜ë©´) message_ends_at or remaining_seconds + sent_msg_count */
async function loadEventState(){
  const res = await fetch("/api/event-state/");
  if(!res.ok){ return {message_open:false}; }
  return await res.json();
}

async function loadCards(){
  const res = await fetch("/api/cards/");
  if(!res.ok) return [];
  const d = await res.json();
  return d.cards || [];
}

async function hydrateRecipients(){
  const cards = await loadCards();
  const sel = document.getElementById("toSelect");
  sel.innerHTML = `<option value="">ë°›ëŠ” ì‚¬ëŒ ì„ íƒ</option>`;
  for(const c of cards){
    const opt = document.createElement("option");
    opt.value = c.id;
    opt.textContent = c.nickname;
    sel.appendChild(opt);
  }
}

/* 2ë¶€ íƒ€ì´ë¨¸ í‘œì‹œ */
function startTimerFromState(state){
  // ìš°ì„ ìˆœìœ„: remaining_seconds -> message_ends_at -> fallback none
  let remain = null;

  if(typeof state.remaining_seconds === "number"){
    remain = state.remaining_seconds;
  } else if(state.message_ends_at){
    // ISO stringì´ë¼ê³  ê°€ì •
    const end = new Date(state.message_ends_at).getTime();
    const now = Date.now();
    remain = Math.max(0, Math.floor((end - now)/1000));
  }

  if(remain === null){
    // ì„œë²„ê°€ ì•ˆ ë‚´ë ¤ì£¼ë©´ íƒ€ì´ë¨¸ ëŒ€ì‹  'ì§„í–‰ ì¤‘'ë§Œ ë³´ì—¬ì¤Œ
    document.getElementById("remain").innerText = "--:--";
    return;
  }

  // ê¸°ì¡´ interval ì œê±°
  if(timerInterval) clearInterval(timerInterval);

  // ìµœì´ˆ í‘œê¸°
  document.getElementById("remain").innerText = fmtRemain(remain);

  timerInterval = setInterval(()=>{
    remain -= 1;
    document.getElementById("remain").innerText = fmtRemain(remain);

    if(remain <= 0){
      clearInterval(timerInterval);
      messageLocked = true;
      setUIForOpen();
      showFx({title:"TIME OVER", sub:"ë©”ì‹œì§€ ê¸°ëŠ¥ì´ ìë™ ì ê¸ˆëì–´ìš”", name:"ë‹¤ìŒ ê¸°íšŒë¥¼ ë…¸ë ¤ë´ ğŸ”’"});
    }
  }, 1000);
}

/* ì „ì†¡ ì—¬ë¶€/ì œí•œ í‘œê¸° */
function applyLimitFromState(state){
  // state.sent_msg_count ê°€ ìˆìœ¼ë©´ ì‚¬ìš©
  const sent = (typeof state.sent_msg_count === "number") ? state.sent_msg_count : 0;
  document.getElementById("sentMsg").innerText = sent;

  // ì´ë¯¸ ë³´ë‚´ë©´ composer ìˆ¨ê¸°ê¸°
  messageSent = sent >= 1;
}

/* ë©”ì¸ ë¶€íŒ… */
async function boot(){
  await loadMe();
  await loadMessageCount();

  const state = await loadEventState();
  stateCache = state;

  messageOpen = !!state.message_open;
  messageLocked = !!state.message_locked; // ìˆìœ¼ë©´ ì‚¬ìš© (ì—†ìœ¼ë©´ ì•„ë˜ íƒ€ì´ë¨¸ë¡œ ì ê¸ˆ)
  applyLimitFromState(state);

  if(!messageOpen){
    setUIForClosed();
    return;
  }

  // ì˜¤í”ˆ UI
  await hydrateRecipients();
  setUIForOpen();

  // íƒ€ì´ë¨¸ ì‹œì‘(ê°€ëŠ¥í•  ë•Œ)
  startTimerFromState(state);

  // ì˜¤í”ˆ ìˆœê°„ íŠ¹ìˆ˜ ì—°ì¶œ(ì„¸ì…˜ë‹¹ 1ë²ˆ)
  const fxKey = "onelight_message_fx_shown";
  if(!localStorage.getItem(fxKey)){
    showFx({title:"2ë¶€ ê¸°ëŠ¥ OPEN", sub:"10ë¶„ ë™ì•ˆ 1íšŒë§Œ", name:"ì§€ê¸ˆë§Œ ê°€ëŠ¥í•œ ë©”ì‹œì§€ âœ¨"});
    localStorage.setItem(fxKey, "1");
  }
}

document.getElementById("text").addEventListener("input", (e)=>{
  document.getElementById("count").innerText = e.target.value.length;
});

document.getElementById("sendBtn").onclick = async ()=>{
  if(!messageOpen){
    alert("ì•„ì§ 2ë¶€ ì˜¤í”ˆ ì „ì…ë‹ˆë‹¤.");
    return;
  }
  if(messageLocked){
    alert("ì‹œê°„ì´ ì¢…ë£Œë˜ì–´ ì ê¸ˆëì–´ìš”.");
    return;
  }
  if(messageSent){
    alert("ë©”ì‹œì§€ëŠ” 1íšŒë§Œ ë³´ë‚¼ ìˆ˜ ìˆì–´ìš”.");
    return;
  }

  const to_id = document.getElementById("toSelect").value;
  const text = document.getElementById("text").value.trim();

  if(!to_id){ alert("ë°›ëŠ” ì‚¬ëŒì„ ì„ íƒí•´ì¤˜"); return; }
  if(!text){ alert("ë‚´ìš©ì„ ì…ë ¥í•´ì¤˜"); return; }
  if(text.length > 200){ alert("200ì ì´ë‚´ë¡œ ì‘ì„±í•´ì¤˜"); return; }

  const csrftoken = getCookie("csrftoken");

  const res = await fetch("/api/message/", {
    method: "POST",
    credentials: "same-origin",
    headers: {"Content-Type":"application/json","X-CSRFToken": csrftoken},
    body: JSON.stringify({to_id, text})
  });

  const data = await res.json().catch(()=> ({}));
  if(!res.ok){
    alert(data.error || "ì „ì†¡ ì‹¤íŒ¨");
    return;
  }

  // âœ… ì „ì†¡ ì™„ë£Œ ì²˜ë¦¬: composer ìˆ¨ê¹€ + ë²„íŠ¼ ë¹„í™œì„± + FX
  messageSent = true;
  document.getElementById("composerCard").classList.add("hidden");
  document.getElementById("actionBtn").innerText = "ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ";
  document.getElementById("actionBtn").disabled = true;

  // ì „ì†¡ ì¹´ìš´íŠ¸ UI
  document.getElementById("sentMsg").innerText = "1";

  showFx({title:"SENT âœ¨", sub:"ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ", name:"ê´€ë¦¬ì í™•ì¸ í›„ ê³µê°œë  ìˆ˜ ìˆì–´ìš”"});

  // ì…ë ¥ ì´ˆê¸°í™”
  document.getElementById("text").value = "";
  document.getElementById("count").innerText = "0";
};
boot();
</script>
</body>
</html>
