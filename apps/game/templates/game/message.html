<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë©”ì‹œì§€</title>
  <style>
    body{font-family:system-ui;margin:0;padding:24px;background:#0b0b0f;color:#fff}
    .wrap{max-width:560px;margin:0 auto;display:flex;flex-direction:column;gap:14px}
    .card{background:#141420;border-radius:18px;padding:16px}
    .title{font-weight:900;margin-bottom:6px}
    .muted{opacity:.7;font-size:13px;line-height:1.4}
    .pill{display:inline-block;background:#1f1f2c;border-radius:999px;padding:8px 12px;font-weight:900;margin-top:8px}
    .btn{
      width:100%;padding:14px;border-radius:14px;border:0;font-weight:900;
      background:#c714c7;color:#fff;cursor:pointer
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}
    select,textarea{
      width:100%;margin-top:10px;background:#0b0b0f;color:#fff;
      border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:12px;font-size:15px
    }
    textarea{min-height:96px}
    .row{display:flex;gap:10px}
    .row button{flex:1;background:#2a2a3a}
    .hidden{display:none}
  </style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <div class="title">ë©”ì‹œì§€</div>
    <div id="desc" class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

    <div class="pill">ğŸ“© ë°›ì€ ë©”ì‹œì§€: <span id="msgCount">0</span>ê°œ</div>

    <button id="actionBtn" class="btn" disabled>í™•ì¸ ì¤‘...</button>
  </div>

  <!-- ë©”ì‹œì§€ ì‘ì„± ì˜ì—­ (ì˜¤í”ˆ í›„ì—ë§Œ í‘œì‹œ) -->
  <div id="composerCard" class="card hidden">
    <div class="title">ë©”ì„¸ì§€ ë³´ë‚´ê¸°</div>
    <div class="muted">ë‹‰ë„¤ì„ì„ ì„ íƒí•˜ê³  200ì ì´ë‚´ë¡œ ë³´ë‚´ì„¸ìš”. (ë©”ì‹œì§€ ë‚´ìš©ì€ í˜„ì¬ ê´€ë¦¬ìë§Œ í™•ì¸)</div>

    <select id="toSelect">
      <option value="">ë°›ëŠ” ì‚¬ëŒ ì„ íƒ</option>
    </select>

    <textarea id="text" maxlength="200" placeholder="200ì ì´ë‚´"></textarea>
    <div class="muted"><span id="count">0</span>/200</div>

    <button id="sendBtn" class="btn">ì „ì†¡</button>
  </div>

  <div class="row">
    <button class="btn" style="background:#2a2a3a" onclick="location.href='/match/'">ë§¤ì¹­ í™•ì¸</button>
    <button class="btn" style="background:#2a2a3a" onclick="location.href='/lobby/'">ë¡œë¹„</button>
  </div>

</div>

<form style="display:none;">{% csrf_token %}</form>

<script>
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}

let me = null;
let messageOpen = false;

async function loadMe(){
  const res = await fetch("/api/me/");
  if(!res.ok){ location.href="/"; return; }
  me = await res.json();
}

async function loadMessageCount(){
  // ë„¤ ë°±ì—”ë“œê°€ /api/message-count/ ê°™ì€ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì“°ë©´ ê±°ê¸°ì— ë§ì¶° ë³€ê²½í•´ì¤˜ì•¼ í•¨.
  // ì§€ê¸ˆ í”„ë¡œì íŠ¸ ê¸°ì¤€: /api/messages/ ëŒ€ì‹  "ê°œìˆ˜ë§Œ" ì—”ë“œí¬ì¸íŠ¸ë¥¼ ë”°ë¡œ ì“°ëŠ” êµ¬ì¡°ê°€ í•„ìš”.
  // (ì´ë¯¸ ë„ˆê°€ ë§í•œ ìš”êµ¬ì‚¬í•­ì´ë¼ ë¶„ë¦¬í–ˆë‹¤ê³  ê°€ì •)
  const res = await fetch("/api/message-count/");
  if(res.ok){
    const d = await res.json();
    document.getElementById("msgCount").innerText = d.count ?? 0;
  }
}

async function loadEventState(){
  const res = await fetch("/api/event-state/");
  if(!res.ok){ return {message_open:false}; }
  return await res.json();
}

async function loadCards(){
  // ë°˜ëŒ€ ì„±ë³„ ëª©ë¡ì„ ê·¸ëŒ€ë¡œ ì“°ë˜, ë©”ì‹œì§€ëŠ” ë§¤ì¹­ ì—¬ë¶€ì™€ ë¬´ê´€í•˜ê²Œ ì„ íƒ ê°€ëŠ¥í•˜ê²Œ êµ¬ì„±
  const res = await fetch("/api/cards/");
  if(!res.ok) return [];
  const d = await res.json();
  return d.cards || [];
}

function setPreOpenUI(){
  document.getElementById("desc").innerText = "ë©”ì‹œì§€ ê¸°ëŠ¥ì€ 2ë¶€ì—ì„œ ì˜¤í”ˆë©ë‹ˆë‹¤.";
  const btn = document.getElementById("actionBtn");
  btn.innerText = "2ë¶€ì—ëŠ” ì¶”ê°€ê¸°ëŠ¥ì´ ì˜¤í”ˆë©ë‹ˆë‹¤";
  btn.disabled = true;
  document.getElementById("composerCard").classList.add("hidden");
}

async function setOpenUI(){
  document.getElementById("desc").innerText = "2ë¶€ ë©”ì‹œì§€ ê¸°ëŠ¥ì´ ì˜¤í”ˆë˜ì—ˆìŠµë‹ˆë‹¤. (10ë¶„ / 1íšŒ ì œí•œ)";
  const btn = document.getElementById("actionBtn");
  btn.innerText = "ë©”ì„¸ì§€ ë³´ë‚´ê¸°";
  btn.disabled = false;
  btn.onclick = () => {
    document.getElementById("composerCard").classList.remove("hidden");
    document.getElementById("composerCard").scrollIntoView({behavior:"smooth"});
  };

  const cards = await loadCards();
  const sel = document.getElementById("toSelect");
  sel.innerHTML = `<option value="">ë°›ëŠ” ì‚¬ëŒ ì„ íƒ</option>`;
  for(const c of cards){
    const opt = document.createElement("option");
    opt.value = c.id;
    opt.textContent = c.nickname;
    sel.appendChild(opt);
  }
}

async function boot(){
  await loadMe();
  await loadMessageCount();

  const state = await loadEventState();
  messageOpen = !!state.message_open;

  if(!messageOpen){
    setPreOpenUI();
  }else{
    await setOpenUI();
  }
}

document.getElementById("text").addEventListener("input", (e)=>{
  document.getElementById("count").innerText = e.target.value.length;
});

document.getElementById("sendBtn").onclick = async ()=>{
  if(!messageOpen){
    alert("ì•„ì§ 2ë¶€ ì˜¤í”ˆ ì „ì…ë‹ˆë‹¤.");
    return;
  }

  const to_id = document.getElementById("toSelect").value;
  const text = document.getElementById("text").value.trim();

  if(!to_id){ alert("ë°›ëŠ” ì‚¬ëŒì„ ì„ íƒí•´ì¤˜"); return; }
  if(!text){ alert("ë‚´ìš©ì„ ì…ë ¥í•´ì¤˜"); return; }
  if(text.length > 200){ alert("200ì ì´ë‚´ë¡œ ì‘ì„±í•´ì¤˜"); return; }

  const csrftoken = getCookie("csrftoken");

  const res = await fetch("/api/message/", {
    method: "POST",
    credentials: "same-origin",
    headers: {"Content-Type":"application/json","X-CSRFToken": csrftoken},
    body: JSON.stringify({to_id, text})
  });

  const data = await res.json().catch(()=> ({}));
  if(!res.ok){
    alert(data.error || "ì „ì†¡ ì‹¤íŒ¨");
    return;
  }

  alert("ì „ì†¡ ì™„ë£Œ!");
  document.getElementById("text").value = "";
  document.getElementById("count").innerText = "0";
};
boot();
</script>
</body>
</html>
